# üê≥ Deploy do Sistema de Backup em Container - EasyPanel

## üìã Vis√£o Geral

Sistema de backup containerizado para deploy no EasyPanel, executando em servidor separado do banco PostgreSQL, conectando remotamente via rede.

## üèóÔ∏è Arquitetura Containerizada

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PostgreSQL    ‚îÇ    ‚îÇ   Backup        ‚îÇ    ‚îÇ      MinIO      ‚îÇ
‚îÇ   Servidor A    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   Container     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   Servidor C    ‚îÇ
‚îÇ   (Produ√ß√£o)    ‚îÇ    ‚îÇ   EasyPanel     ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ   Servidor B    ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤                       ‚ñ≤                       ‚ñ≤
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   EasyPanel     ‚îÇ
                    ‚îÇ   Management    ‚îÇ
                    ‚îÇ   Interface     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Estrutura do Projeto Containerizado

```
songmetrix-backup-container/
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ postgres-backup.js
‚îÇ   ‚îú‚îÄ‚îÄ supabase-backup.js
‚îÇ   ‚îú‚îÄ‚îÄ minio-client.js
‚îÇ   ‚îú‚îÄ‚îÄ backup-orchestrator.js
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-service.js
‚îÇ   ‚îî‚îÄ‚îÄ cleanup-service.js
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ backup-config.json
‚îÇ   ‚îú‚îÄ‚îÄ postgres-config.json
‚îÇ   ‚îú‚îÄ‚îÄ supabase-config.json
‚îÇ   ‚îî‚îÄ‚îÄ minio-config.json
‚îú‚îÄ‚îÄ logs/
‚îú‚îÄ‚îÄ temp/
‚îî‚îÄ‚îÄ backup-cron
```

## üê≥ Dockerfile Otimizado

```dockerfile
# Usar Node.js LTS
FROM node:18-alpine

# Instalar depend√™ncias do sistema
RUN apk add --no-cache \
    postgresql-client \
    curl \
    wget \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/*

# Configurar timezone
ENV TZ=America/Sao_Paulo

# Criar usu√°rio n√£o-root
RUN addgroup -g 1001 -S backupuser && \
    adduser -S backupuser -u 1001 -G backupuser

# Criar diret√≥rios
RUN mkdir -p /app/{scripts,config,logs,temp} && \
    chown -R backupuser:backupuser /app

# Definir diret√≥rio de trabalho
WORKDIR /app

# Copiar arquivos de configura√ß√£o primeiro (para cache de layers)
COPY package*.json ./
COPY config/ ./config/

# Instalar depend√™ncias
RUN npm ci --only=production && \
    npm cache clean --force

# Copiar scripts
COPY scripts/ ./scripts/

# Copiar script de inicializa√ß√£o
COPY backup-cron ./backup-cron

# Dar permiss√µes de execu√ß√£o
RUN chmod +x ./backup-cron && \
    chmod +x ./scripts/*.js

# Mudar para usu√°rio n√£o-root
USER backupuser

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node -e "console.log('Backup service is healthy')" || exit 1

# Comando padr√£o
CMD ["/app/backup-cron"]
```

## üìÑ docker-compose.yml para EasyPanel

```yaml
version: '3.8'

services:
  songmetrix-backup:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: songmetrix-backup-service
    restart: unless-stopped

    # Configura√ß√µes de rede
    networks:
      - backup-network

    # Vari√°veis de ambiente
    environment:
      - NODE_ENV=production
      - TZ=America/Sao_Paulo
      - POSTGRES_HOST=104.234.173.96
      - POSTGRES_PORT=5433
      - POSTGRES_DB=music_log
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Conquista@@2
      - SUPABASE_URL=https://aylxcqaddelwxfukerhr.supabase.co
      - SUPABASE_SERVICE_KEY=your_service_key_here
      - MINIO_ENDPOINT=console.files.songmetrix.com.br
      - MINIO_ACCESS_KEY=your_minio_access_key
      - MINIO_SECRET_KEY=your_minio_secret_key
      - BACKUP_RETENTION_DAILY=7
      - BACKUP_RETENTION_WEEKLY=4
      - BACKUP_RETENTION_MONTHLY=12

    # Volumes para persistir dados
    volumes:
      - backup_logs:/app/logs
      - backup_temp:/app/temp
      - backup_config:/app/config
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

    # Configura√ß√µes de seguran√ßa
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

    # Recursos
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('fs').accessSync('/app/scripts/backup-orchestrator.js')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels para EasyPanel
    labels:
      - "easypanel.managed=true"
      - "easypanel.service=backup"
      - "easypanel.description=Songmetrix Database Backup Service"

# Rede isolada para backup
networks:
  backup-network:
    driver: bridge
    internal: false

# Volumes persistentes
volumes:
  backup_logs:
    driver: local
  backup_temp:
    driver: local
  backup_config:
    driver: local
```

## üìú Script de Inicializa√ß√£o (backup-cron)

```bash
#!/bin/sh

# Script de inicializa√ß√£o do container de backup
# Executa o backup e mant√©m o container rodando

echo "üöÄ Iniciando Songmetrix Backup Service..."
echo "üìÖ $(date)"

# Criar arquivos de log se n√£o existirem
touch /app/logs/backup.log
touch /app/logs/cron.log
touch /app/logs/errors.log

# Fun√ß√£o de backup
run_backup() {
    echo "üìä Executando backup completo... $(date)" >> /app/logs/cron.log
    node /app/scripts/backup-orchestrator.js >> /app/logs/cron.log 2>&1
    echo "‚úÖ Backup conclu√≠do $(date)" >> /app/logs/cron.log
}

# Fun√ß√£o de limpeza
run_cleanup() {
    echo "üßπ Executando limpeza... $(date)" >> /app/logs/cron.log
    node /app/scripts/cleanup-service.js >> /app/logs/cron.log 2>&1
}

# Fun√ß√£o de monitoramento
run_monitoring() {
    echo "üëÄ Executando monitoramento... $(date)" >> /app/logs/cron.log
    node /app/scripts/monitoring-service.js >> /app/logs/cron.log 2>&1
}

# Backup inicial (ap√≥s 30 segundos)
echo "‚è≥ Aguardando inicializa√ß√£o do sistema..."
sleep 30
run_backup

# Loop principal com cron
echo "üîÑ Iniciando loop de backup..."
while true; do
    # Verificar hora atual
    HOUR=$(date +%H)
    MINUTE=$(date +%M)
    DAY=$(date +%d)
    WEEKDAY=$(date +%w)  # 0=domingo

    # Backup di√°rio √†s 02:00
    if [ "$HOUR" = "02" ] && [ "$MINUTE" = "00" ]; then
        run_backup
        sleep 60  # Evitar m√∫ltiplas execu√ß√µes
    fi

    # Backup semanal aos domingos √†s 03:00
    if [ "$WEEKDAY" = "0" ] && [ "$HOUR" = "03" ] && [ "$MINUTE" = "00" ]; then
        echo "üìÖ Executando backup semanal... $(date)" >> /app/logs/cron.log
        node /app/scripts/weekly-backup.js >> /app/logs/cron.log 2>&1
        sleep 60
    fi

    # Limpeza mensal no dia 1 √†s 04:00
    if [ "$DAY" = "01" ] && [ "$HOUR" = "04" ] && [ "$MINUTE" = "00" ]; then
        run_cleanup
        sleep 60
    fi

    # Monitoramento a cada 6 horas
    if [ "$MINUTE" = "00" ] && ([ "$HOUR" = "00" ] || [ "$HOUR" = "06" ] || [ "$HOUR" = "12" ] || [ "$HOUR" = "18" ]); then
        run_monitoring
        sleep 60
    fi

    # Aguardar 1 minuto antes de verificar novamente
    sleep 60
done
```

## ‚öôÔ∏è Configura√ß√£o do EasyPanel

### 1. **Criar Novo Servi√ßo**
- Acesse o EasyPanel
- Clique em "Add Service"
- Selecione "Docker Compose"

### 2. **Configurar o Servi√ßo**
```yaml
# Cole o docker-compose.yml acima
# Configure as vari√°veis de ambiente
# Defina os volumes persistentes
```

### 3. **Configura√ß√µes de Rede**
- Permita acesso √† rede externa para conectar ao PostgreSQL
- Configure firewall para portas necess√°rias (5433, 9000)

### 4. **Monitoramento**
- Configure health checks
- Defina alertas para falhas
- Monitore logs em tempo real

## üîß Scripts Adaptados para Container

### Modifica√ß√µes Necess√°rias:

#### 1. **Caminhos Absolutos**
```javascript
// Antes
const logFile = path.join(__dirname, '../logs/backup.log');

// Depois (container)
const logFile = '/app/logs/backup.log';
```

#### 2. **Vari√°veis de Ambiente**
```javascript
// Configura√ß√µes via environment variables
const postgresConfig = {
  host: process.env.POSTGRES_HOST || '104.234.173.96',
  port: parseInt(process.env.POSTGRES_PORT) || 5433,
  database: process.env.POSTGRES_DB || 'music_log',
  username: process.env.POSTGRES_USER || 'postgres',
  password: process.env.POSTGRES_PASSWORD || 'Conquista@@2'
};
```

#### 3. **Tratamento de Erros Robusto**
```javascript
process.on('uncaughtException', (error) => {
  console.error('‚ùå Erro n√£o tratado:', error);
  // Log to file and exit gracefully
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Promessa rejeitada:', reason);
  // Log and handle
});
```

## üìä Monitoramento no EasyPanel

### 1. **Logs em Tempo Real**
```bash
# Visualizar logs do container
docker logs -f songmetrix-backup-service

# Logs espec√≠ficos
docker exec songmetrix-backup-service tail -f /app/logs/backup.log
```

### 2. **M√©tricas do Container**
- CPU e mem√≥ria utilizados
- Status de health check
- Rede e I/O
- Volumes utilizados

### 3. **Alertas Configurados**
- Container parado
- Health check falhando
- Uso excessivo de recursos
- Falha nos backups

## üöÄ Estrat√©gia de Deploy

### **Fase 1: Prepara√ß√£o**
```bash
# 1. Clonar reposit√≥rio
git clone https://github.com/your-repo/songmetrix-backup.git
cd songmetrix-backup

# 2. Configurar vari√°veis de ambiente
cp .env.example .env
nano .env

# 3. Testar localmente
npm install
npm test
```

### **Fase 2: Build da Imagem**
```bash
# Build da imagem
docker build -t songmetrix-backup:latest .

# Teste da imagem
docker run --rm -it songmetrix-backup:latest node scripts/backup-orchestrator.js
```

### **Fase 3: Deploy no EasyPanel**
```bash
# 1. Upload dos arquivos para o servidor
scp -r . user@easypanel-server:/opt/songmetrix-backup/

# 2. Deploy via EasyPanel interface
# - Criar novo servi√ßo
# - Upload do docker-compose.yml
# - Configurar volumes e rede
# - Iniciar servi√ßo
```

### **Fase 4: Valida√ß√£o**
```bash
# 1. Verificar se container est√° rodando
docker ps | grep songmetrix-backup

# 2. Verificar logs
docker logs songmetrix-backup-service

# 3. Testar conectividade
docker exec songmetrix-backup-service node scripts/monitoring-service.js

# 4. Verificar backups no MinIO
mc ls songmetrix-backups/daily/
```

## üõ°Ô∏è Seguran√ßa do Container

### 1. **Imagens Seguras**
```dockerfile
# Usar imagens oficiais e atualizadas
FROM node:18-alpine

# N√£o executar como root
USER backupuser

# Permiss√µes m√≠nimas
RUN chmod 755 /app/scripts/*.js
```

### 2. **Secrets Management**
```yaml
# Usar secrets do Docker ou EasyPanel
secrets:
  postgres_password:
    external: true
  minio_secret_key:
    external: true
```

### 3. **Network Security**
```yaml
# Rede isolada
networks:
  backup-network:
    internal: true
```

### 4. **Resource Limits**
```yaml
# Limites de recursos
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
```

## üìà Escalabilidade

### 1. **Horizontal Scaling**
- M√∫ltiplas inst√¢ncias do container
- Load balancer para distribui√ß√£o
- Coordena√ß√£o via Redis ou database

### 2. **Vertical Scaling**
- Ajuste din√¢mico de recursos
- Auto-scaling baseado em carga
- Otimiza√ß√£o de performance

### 3. **Backup Paralelo**
- Execu√ß√£o paralela de backups
- Queue system para m√∫ltiplos databases
- Rate limiting para APIs

## üéØ Benef√≠cios da Containeriza√ß√£o

### **Isolamento**
- ‚úÖ Ambiente isolado do host
- ‚úÖ Depend√™ncias controladas
- ‚úÖ F√°cil rollback de vers√µes

### **Portabilidade**
- ‚úÖ Mesmo ambiente em dev/staging/prod
- ‚úÖ Deploy consistente
- ‚úÖ Migra√ß√£o entre servidores

### **Gerenciamento**
- ‚úÖ EasyPanel integration
- ‚úÖ Monitoramento integrado
- ‚úÖ Logs centralizados

### **Escalabilidade**
- ‚úÖ Horizontal e vertical scaling
- ‚úÖ Auto-healing
- ‚úÖ Resource optimization

---

## üöÄ **Resultado Final:**

**Sistema de backup containerizado** pronto para deploy no EasyPanel com:

- üê≥ **Container isolado** em servidor separado
- üîó **Conex√£o remota** ao PostgreSQL de produ√ß√£o
- ‚òÅÔ∏è **Upload autom√°tico** para MinIO
- ‚è∞ **Automa√ß√£o completa** via cron interno
- üëÄ **Monitoramento integrado** no EasyPanel
- üõ°Ô∏è **Seguran√ßa avan√ßada** com usu√°rio n√£o-root
- üìä **M√©tricas em tempo real** via interface

**üéâ Deploy em 3 passos:**
1. Upload do projeto para o servidor EasyPanel
2. Configurar docker-compose.yml no EasyPanel
3. Iniciar servi√ßo e monitorar

**O backup estar√° rodando automaticamente em background!** üõ°Ô∏è