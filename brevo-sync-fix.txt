## INSTRUÇÕES PARA CORRIGIR O PROBLEMA DE SINCRONIZAÇÃO COM BREVO

Para resolver o problema atual com o Brevo, é necessário modificar o código para tratar corretamente o erro "Contact already in list" como um sucesso, não como uma falha.

1. Localize no arquivo server/server.js a seguinte parte do código (por volta da linha 2840 ou procure por "Adicionar à lista correta"):

```js
// 3. Adicionar à lista correta
const addResponse = await fetch(`https://api.brevo.com/v3/contacts/lists/${targetListId}/contacts/add`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'api-key': brevoApiKey
  },
  body: JSON.stringify({
    emails: [user.email]
  })
});

if (!addResponse.ok) {
  const addError = await addResponse.text();
  console.error(`Erro ao adicionar ${user.email} à lista ${targetListId}:`, addError);
  return { 
    success: false, 
    error: `Erro ao adicionar à lista: ${addError}`,
    email: user.email
  };
}
```

2. Substitua este bloco pelo seguinte código:

```js
// 3. Adicionar à lista correta
const addResponse = await fetch(`https://api.brevo.com/v3/contacts/lists/${targetListId}/contacts/add`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'api-key': brevoApiKey
  },
  body: JSON.stringify({
    emails: [user.email]
  })
});

if (!addResponse.ok) {
  const addError = await addResponse.text();
  console.error(`Erro ao adicionar ${user.email} à lista ${targetListId}:`, addError);
  
  // Verificar se o erro é "Contact already in list"
  if (addError.includes("already in list")) {
    console.log(`Contato ${user.email} já está na lista ${targetListId}, considerando como sucesso`);
    return { 
      success: true, 
      message: `Contato atualizado (já estava na lista)`,
      email: user.email,
      status: user.status,
      listId: targetListId
    };
  }
  
  return { 
    success: false, 
    error: `Erro ao adicionar à lista: ${addError}`,
    email: user.email
  };
}
```

3. Localize também o mesmo padrão de código em outras partes do arquivo, especialmente na seção que trata da adição de contatos duplicados (procure por `Erro de duplicação, tentando atualizar`) e faça a mesma modificação.

4. Salve o arquivo e reinicie o servidor.

Estas alterações garantirão que quando um contato já estiver na lista do Brevo, o sistema considerará isso como um sucesso e não como uma falha, aumentando significativamente a taxa de sucesso na sincronização. 